# Hotel Churn implementation using Azure Machine Learning Designer

## Training Pipeline
|Step No|Step  |Description  |Details  |
|--|--|--|--|
|1|Add Dataset(s)  |Create three datasets <br/>a. **[HotelActivity ](https://testamlcustommodel.blob.core.windows.net/custommodels/datasets/ContosoHotel_HotelActivity.txt)** <br/>b. **[Customers](https://testamlcustommodel.blob.core.windows.net/custommodels/datasets/Customer.csv)**<br/>c. **[ServiceUsage](https://testamlcustommodel.blob.core.windows.net/custommodels/datasets/ContosoHotel_ServiceUsage.txt)** <br/> |!["Step 1"](media/intelligence-designer-walkthrough-step1.png "Step 1")|
|2|Select Columns | Select the following columns for each dataset <br/> a. **HotelActivity** <br/> <ul><li>HotelCustomerID</li><li>CheckInDate</li><li>CheckOutDate</li><li>RoomType</li><li>DollarsSpent</li><li>BookingType</li><li>TravelCategory</li><li>NumberOfNights</li></ul> <br/> b. **Customers** <br/> <ul><li>CustomerId</li><li>ContosoHotel_HotelCustomers_HotelCustomerID</li></ul> <br/> c. **ServiceUsage** <br/> <ul><li>ServicesCustomerID</li><li>ServiceName</li><li>ServiceDate</li><li>ServiceCost</li></ul>  | !["Step 2"](media/intelligence-designer-walkthrough-step2.png "Step 2") |
|3|Join Data|Join the data between the HotelActivity and Customers datasets. Use the following columns for the join: <br/> **HotelActivity** - HotelCustomerID <br/> **Customers** - ContosoHotel_HotelCustomers_HotelCustomerID |!["Step 3a"](media/intelligence-designer-walkthrough-step3a.png "Step 3a") <br/><br/> !["Step 3b"](media/intelligence-designer-walkthrough-step3b.png "Step 3b")|
|4|Select Columns|Select the following columns from your results from **Step 3**: <br/> <br/> HotelCustomerID, RoomType, DollarsSpent, BookingType, TravelCategory, CheckInDate, CheckOutDate, NumberOfNights, CustomerId|!["Step 4"](media/intelligence-designer-walkthrough-step4.png "Step 4")|
|5|Apply SQL transformation|Apply the following SQL transformation to filter the data from the Join step <br/><br/> _select * from t1 where [CheckInDate] < "2016-12-31T00:00:00"_|!["Step 5"](media/intelligence-designer-walkthrough-step5.png "Step 5")|
|6|Edit Metadata|Change the Data type of the NumberOFNights column to Integer|!["Step 6"](media/intelligence-designer-walkthrough-step6.png "Step 6")|
|7|Convert to Indicator Values|Convert the following categorical columns to a series of binary indicator values: <br/> RoomType, BookingType, TravelCategory|!["Step 7"](media/intelligence-designer-walkthrough-step7.png "Step 7")|
|8 |Edit Metadata |Change the data types of the following columns to Integer. Additionally, specify that the columns should be treated as **Features**. <br/> RoomType-Large, RoomType-Small, BookingType-Online, BookingType-Phone Call, TravelCategory-Business, TravelCategory-Leisure |!["Step 8"](media/intelligence-designer-walkthrough-step8.png "Step 8")  |
|9|Apply SQL transformation|Apply the following SQL  transformation: <br/><br/> _select HotelCustomerID, CustomerId, sum([RoomType-Large]) as RoomTypeLargeCount, sum([RoomType-Small]) as RoomTypeSmallCount, sum([BookingType-Online]) as BookingTypeOnlineCount, sum([BookingType-Phone Call]) as BookingTypePhoneCallCount, sum([TravelCategory-Business]) as TravelCategoryBusinessCount, sum([TravelCategory-Leisure]) as TravelCategoryLeisureCount, sum([DollarsSpent]) as TotalDollarSpent from t1 group by HotelCustomerID;_|!["Step 9"](media/intelligence-designer-walkthrough-step9.png "Step 9")|
|10|Edit Metadata | Change the data type of the **NumberOfNights** column from the results of **Step 4** to Integer| !["Step 10"](media/intelligence-designer-walkthrough-step10.png "Step 10")|
|11 | Apply SQL Transformation | Apply the following SQL transformation: <br/><br/> _with StayInfo as (<br/> select HotelCustomerID,<br/> sum(case when [CheckOutDate] <= "2016-12-31T00:00:00" then [NumberOfNights] else 0 end) as StayDayCount,<br/> sum(case when [CheckOutDate] <= "2016-12-31T00:00:00" and [CheckOutDate] >= "2015-01-01T00:00:00" then [NumberOfNights] else 0 end) as StayDayCount2016,<br/> sum(case when [CheckOutDate] <= "2015-12-31T00:00:00" and [CheckOutDate] >= "2014-01-01T00:00:00" then [NumberOfNights] else 0 end) as StayDayCount2015,<br/> sum(case when [CheckOutDate] <= "2014-12-31T00:00:00" and [CheckOutDate] >= "2013-01-01T00:00:00" then [NumberOfNights] else 0 end) as StayDayCount2014,<br/> sum(case when [CheckOutDate] <= "2016-12-31T00:00:00" then 1 else 0 end) as StayCount,<br/> sum(case when [CheckOutDate] <= "2016-12-31T00:00:00" and [CheckOutDate] >= "2015-01-01T00:00:00" then 1 else 0 end) as StayCount2016,<br/> sum(case when [CheckOutDate] <= "2015-12-31T00:00:00" and [CheckOutDate] >= "2014-01-01T00:00:00" then 1 else 0 end) as StayCount2015,<br/> sum(case when [CheckOutDate] <= "2014-12-31T00:00:00" and [CheckOutDate] >= "2013-01-01T00:00:00" then 1 else 0 end) as StayCount2014,<br/> min([CheckInDate]) as FirstStay,<br/> max([CheckOutDate]) as LastStay<br/> from t1 <br/> group by HotelCustomerID)_ <br/><br/> _select HotelCustomerID, StayDayCount, StayDayCount2016, StayDayCount2015, StayDayCount2014, StayCount, StayCount2016, StayCount2015, StayCount2014, julianday("2016-12-31T00:00:00") - julianday(FirstStay) as UsageTenure, case when LastStay > "2016-12-31T00:00:00" then 0 else 1 end as Label from StayInfo_; |!["Step 11"](media/intelligence-designer-walkthrough-step11.png "Step 11")|
|12 |Join Data | Join the data between the results from **Steps 9 and 11.** Use the following columns for the join: <br/> **Left** - HotelCustomerID <br/> **Right** - HotelCustomerID | !["Step 12"](media/intelligence-designer-walkthrough-step12.png "Step 12") |
|13 | Apply SQL Transformation | Apply the following SQL transformation to the results from selecting columns from the ServiceUsage dataset in **Step 2**: <br/><br/> _select ServicesCustomerID, <br/> sum(case when ServiceName='concierge' then ServiceCost else 0 end) as ConciergeUsage, <br/> sum(case when ServiceName='courier' then ServiceCost else 0 end) as CourierUsage, <br/> sum(case when ServiceName='dry_cleaning' then ServiceCost else 0 end) as DryCleaningUsage, <br/> sum(case when ServiceName='gym' then ServiceCost else 0 end) as GymUsage, <br/> sum(case when ServiceName='phone' then ServiceCost else 0 end) as PhoneUsage, <br/> sum(case when ServiceName='restaurant' then ServiceCost else 0 end) as RestaurantUsage, <br/> sum(case when ServiceName='spa' then ServiceCost else 0 end) as SpaUsage, <br/> sum(case when ServiceName='television' then ServiceCost else 0 end) as TelevisionUsage, <br/> sum(case when ServiceName='wifi' then ServiceCost else 0 end) as WifiUsage <br/> from t1 where ServiceDate < "2016-12-31T00:00:00" <br/> group by ServicesCustomerID;_ | !["Step 13"](media/intelligence-designer-walkthrough-step13.png "Step 13") |
|14 | Join Data | Join the data between the results from **Steps 12 and 13.** Use the following columns for the join: <br/> **Left** - HotelCustomerID <br/> **Right** - ServicesCustomerID| !["Step 14"](media/intelligence-designer-walkthrough-step14.png "Step 14") |
|15 | Edit Metadata | Mark the following columns as ClearFeatures: <br/><br/> HotelCustomerID, CustomerId | !["Step 15"](media/intelligence-designer-walkthrough-step15.png "Step 15") |
|16 | Edit Metadata | Select the **Label** column to be used as as Label | !["Step 16"](media/intelligence-designer-walkthrough-step16.png "Step 16") |
|17 | Clean Missing Data | Handle any missing values by specifying the settings from the screenshot | !["Step 17"](media/intelligence-designer-walkthrough-step17.png "Step 17") |
|18 | Split Data | Split the results of the cleaned data into 2: 70% for training your model and 30% for testing the trained model | !["Step 18"](media/intelligence-designer-walkthrough-step18.png "Step 18") | 
|19 | Train Model | Add the **Train Model** module and connect the left hand side results of the **Split Data** module (Step 18) to the right hand side of the **Train Model** module. <br/><br/> Specify the column that column that contains the Label or Outcome column. It is the **Label** column in our case. | !["Step 19"](media/intelligence-designer-walkthrough-step19.png "Step 19") |
|20 | Two-Class Boosted Decision Tree | Use the Two-Class Boosted Decision Tree to train your model. Connect the Two-Class Boosted Decision Tree module to the left hand side of the Train Model module (Step 19). Specify the settings shown in the screenshot. | !["Step 20"](media/intelligence-designer-walkthrough-step20.png "Step 20") |
|21 | Score Model | Make predictions using the trained model on your test data. Connect the trained model from the **Train Model** module (Step 19) to the left hand side of the **Score Model** module. Connect the right hand side results of the **Split Data** module (Step 18) to the right hand side of the **Score Model** module. <br/><br/> Check the **Append score columns to output** checkbox so that the columns in your final output will contain all the columns in addition to the Label columns | !["Step 21"](media/intelligence-designer-walkthrough-step21.png "Step 21") |
|22 | Evaluate Model | Evaluate the results of your trained model with standard metrics. | !["Step 22"](media/intelligence-designer-walkthrough-step22.png "Step 22") |
|23 | Submit the pipeline | Click on the **Submit** button to set up your pipeline run. Enter the required details such as **Experiment Name**, and **Run Description**. <br/> Create and select a Compute target for the run if you don't already have one. <br/><br/> Submit the run| !["Step 23"](media/intelligence-designer-walkthrough-step23.png "Step 23") |

## Inference Pipeline
|Step No|Step  |Description  |Details  |
|--|--|--|--|
|1 | Create Batch Inference Pipeline | Once the training pipeline has completed successfully, click _Create inference pipeline -> Batch inference pipeline_ to create a batch inference pipeline from your training pipeline.   | !["Step 24"](media/intelligence-designer-walkthrough-step24.png "Step 24") |
|2 | Dataset Parameterization | In this step, we'll parameterize the 3 datasets so that we can pass in new data from Customer Insights for making predictions. <br/><br/> Select the **HotelActivity** dataset node, and check the _Set as pipeline parameter_ checkbox in the **Parameters** tab of the right side pane. Enter a **Parameter name**, for example, **HotelActivity**, to represent the selected dataset. Repeat for the **Customers** and **ServiceUsage** datasets. | !["Step 25"](media/intelligence-designer-walkthrough-step25.png "Step 25") |
|3 | Export Data | Add the **Export Data** module to your Batch inference pipeline. This module allows us to get our predicted results into Customer Insights. Connect the bottom of the **Score Model** module to the **Export Data** module. <br/><br/> Click on the Export Data module to open the side pane. Make the following changes: <br/><br/> <ul><li>**Datastore type**: Select _Azure Blob Storage_</li><li>**Datastore**: Select _workspaceblobstore_</li><li>**Path**: Enter a name for your predictions output. E.g. _HotelChurnPredictions_</li><li>**File format**: Select _csv_</li></ul> | !["Step 26"](media/intelligence-designer-walkthrough-step26.png "Step 26") |
|4 | Export Data Parameterization | In this step, we'll parameterize our Export Data module so that our predictions can be imported and used within Customer Insights. <br/><br/> Click on the Export Data module to open the side pane and then click on the ellipses on top of the datastore dropdown. <br/>Click on Add to pipeline parameter. Enter a name in the **Parameter Name** textbox that you can easily identify in Customer Insights. Click Save. <br/><br/><br/><br/><br/><br/> Repeat for the Path field.| !["Step 27a"](media/intelligence-designer-walkthrough-step27a.png "Step 27a") <br/> <br/> !["Step 27b"](media/intelligence-designer-walkthrough-step27b.png "Step 27b") <br/><br/> !["Step 27c"](media/intelligence-designer-walkthrough-step27c.png "Step 27c")|
|5 | Submit and Publish Pipeline Endpoint | **Submit** the batch inference pipeline. <br/> Once it has completed successfully, click on **Publish** to open the published pipeline dialog. <br/> Select **Create new** and enter a name for your endpoint. Enter a name that you can easily identify later on. <br/> Click on **Publish** to publish your batch inference pipeline endpoint. It is now discoverable in Customer Insights! | !["Step 28"](media/intelligence-designer-walkthrough-step28.png "Step 28") |

